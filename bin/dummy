#!/usr/bin/env python
import sys
import os
import argparse

__VERSION__ = '0.0.1'
_whatami  = os.path.basename(sys.argv[0])
_ownpath  = os.path.abspath(__file__)
_whereami = os.path.dirname(_ownpath)
_projhome = os.path.dirname(_whereami)

def log(*msgs):
    sys.stderr.write(' '.join(str(m) for m in msgs) + '\n')

def parseargs(args):
    desc = 'Pacbio unofficial pitchfork building system.'
    epil = 'This gets you a subroot-like software deployment. The deployment is unrelocatable but easier to understand.'
    parser = argparse.ArgumentParser(
        epilog=epil,
        description=desc)

    parser.add_argument('-V', '--version', help='show version', action='version', version='%s' % __VERSION__)

    subparsers = parser.add_subparsers(
        dest='subcommand',
        title='subcommands',
        help='Run %s --help for more information' % _whatami)

    sub = subparsers.add_parser('configure',
        help='prints out suggested settings.mk',
        description='What\'s in your settings.mk?')
    sub.add_argument('--prefix',
                     metavar='<prefix>',
                     type=str,
                     help='The path of where you want to deploy software to.')
    sub.add_argument('--python',
                     metavar='<python>',
                     type=str,
                     help='The path of pre-installed python binary that you want to use.')
    sub.add_argument('--workspace',
                     metavar='<workspace>',
                     type=str,
                     help='The path of where you want to build software on.')

    sub = subparsers.add_parser('installed',
        help='Check what\'s being installed',
        description='This will look into the PREFIX directories and list what has been installed.')

    return parser.parse_args()

def pitchfork(args):
    #log('[INFO] args:', args)
    if args.subcommand == 'configure':
        import platform
        myargs = vars(args)
        if 'prefix' in myargs:
            print "PREFIX      = %s" % myargs['prefix']
        if 'workspace' in myargs:
            print "WORKSPACE   = %s" % myargs['workspace']
        if 'python' in myargs:
            print "HAVE_PYTHON = %s" % myargs['python']
        elif platform.system() == 'Darwin':
            print "HAVE_PYTHON ="
    elif args.subcommand == 'installed':
        from glob import glob
        _prefix = ''
        if len(glob('%s/settings.mk' % _projhome)) > 0:
            for line in open('%s/settings.mk' % _projhome, 'r'):
                if 'PREFIX' in line.strip():
                    if line.strip().split('=')[0].strip() == 'PREFIX':
                        _prefix = line.strip().split('=')[1].strip()
                    break
        if 'PREFIX' in os.environ:
            _prefix = "%s" % os.environ['PREFIX']
        elif len(glob(_prefix)) > 0:
            pass
        else:
            if len(glob("deployment")) > 0:
                _prefix = "%s" % os.path.abspath('deployment')
        for mypkg in glob('%s/var/pkg/*' % _prefix):
            print os.path.basename(mypkg)
    else:
        # theoretically impossible
        raise Exception()

def main(argv=sys.argv):
    """Main"""
    pargs = parseargs(argv)
    try:
        pitchfork(pargs)
    except Exception:
        log(repr(vars(pargs)))
        raise
    return 0

if __name__ == '__main__':
    if sys.hexversion < 0x020700F0:
        print "[ERROR] You are using an older system python."
        sys.exit(1)
    sys.exit(main())
